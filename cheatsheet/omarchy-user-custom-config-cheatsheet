#!/bin/bash

CHEAT_FILE="/home/jebin/git/omarchy_custom_config/cheatsheet/cheatsheet.csv"
CONFIG_FILE="/home/jebin/git/omarchy_custom_config/config.toml"

# Ensure Gemini toggle exists in config
grep -q '^SEARCH_WITH_GEMINI=' "$CONFIG_FILE" || echo 'SEARCH_WITH_GEMINI="false"' >> "$CONFIG_FILE"

# Read current GEMINI toggle
SEARCH_WITH_GEMINI=$(awk -F= '/SEARCH_WITH_GEMINI/ {gsub(/[" ]/,"",$2); print $2}' "$CONFIG_FILE")

# Prepare first two rows with proper alignment
COPY_ALL_ROW="$(printf "%-35s → %s" "Copy all cheat" "Copy all cheats to clipboard")"

if [[ "$SEARCH_WITH_GEMINI" == "true" ]]; then
    GEMINI_ROW="$(printf "%-35s → %s" "[✓] Search with Gemini API" "Run Gemini search")"
else
    GEMINI_ROW="$(printf "%-35s → %s" "[ ] Search with Gemini API" "Run Gemini search")"
fi

# Parse cheatsheet and build menu
parse_cheats() {
    awk -F, -v copy_row="$COPY_ALL_ROW" -v gemini_row="$GEMINI_ROW" '
    BEGIN {
        # Firdt row: Gemini toggle
        # print gemini_row
        # Second row: Copy all cheats
        print copy_row
    }
    {
        key = $1
        desc = $2
        printf "%-35s → %s\n", key, desc
    }' "$CHEAT_FILE"
}

# Adjust menu height (40%)
monitor_height=$(hyprctl monitors -j | jq -r '.[] | select(.focused==true) | .height')
menu_height=$((monitor_height * 40 / 100))

# Show menu
selection=$(parse_cheats | walker --dmenu --theme keybindings -p 'Cheatsheet' -w 800 -h "$menu_height")

[ -z "$selection" ] && exit

# Handle first row: Copy all cheats
if [[ "$selection" =~ ^Copy\ all\ cheat ]]; then
    wl-copy < "$CHEAT_FILE"
    notify-send "Cheatsheet" "All cheats copied to clipboard ✅"
    exit
fi

# Handle second row: Gemini toggle
if [[ "$selection" =~ "Search with Gemini API" ]]; then
    if [[ "$SEARCH_WITH_GEMINI" == "true" ]]; then
        sed -i 's/SEARCH_WITH_GEMINI *= *.*/SEARCH_WITH_GEMINI="false"/' "$CONFIG_FILE"
        notify-send "Cheatsheet" "Gemini search disabled ✅"
    else
        sed -i 's/SEARCH_WITH_GEMINI *= *.*/SEARCH_WITH_GEMINI="true"/' "$CONFIG_FILE"
        notify-send "Cheatsheet" "Gemini search enabled ✅"
    fi
    # Rerun menu to reflect updated tick
    exec "$0"
fi

# Handle all other rows: copy command (first column)
command=$(awk -F, -v sel="$selection" '$1 ~ sel {print $1; exit}' "$CHEAT_FILE")
[ -z "$command" ] && command=$(echo "$selection" | awk -F'→' '{print $1}' | xargs)
wl-copy <<< "$command"
notify-send "Cheatsheet" "Command copied: $command ✅"